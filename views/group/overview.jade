extends ../structure/default.jade

include ../includes/modalHelper.jade
include ../includes/basic.jade

block append scripts
    script
        |$('.datepicker').datepicker();
    script(src="/scripts/includes/timeline.js")
    script(src="/scripts/includes/cardicons.js")
    script(src="/scripts/includes/selectTrigger.js")
    script(src="/scripts/overview.js")
    script(src="/scripts/includes/checkedListGroup.js")
    script
        |initListGroup($("#studentUserList"))
    script(src="/scripts/includes/dropzone.min.js")
    script(src="/scripts/includes/dropzoneCustom.js")

block append styles
    link(href="/styles/flip.css" rel="stylesheet")
    link(href="/styles/dropzone.min.css" rel="stylesheet")
    link(href="/styles/dropzoneCustom.css" rel="stylesheet")

block content
    -var users = []
    -var files = fullUser.groups[0].files
    .container
        #finalWarning.hidden
            .alert.alert-info
                p
                    b There are non final assignments! 
                p 
                    |Make sure to either accept or decline all non final assignments (assignments handed in for you by someone else). 
                    br
                    |You can recognize these handins by the light blue dot.
            hr
        h1= group.name
        
        if group.assignments.length > 0 && group.assignments[0].typ == "open" && !user.admin
            h2 Open Assignment
            .row.groups
                - var ass = group.assignments[0]
                - var handins = files.filter(f => f.file.assignment.toString() == ass._id.toString())
                +flipper()(class="group")
                    +front-card() 
                        .assignmentStateBulb.back-open
                        .yAlign
                            h3.special= ass.name
                            +timeline(group.start, group.end)(class="hidden" id="openExists")
                    +back-card()
                        +card-icons()
                            .bottom-icons
                                +card-icon("Upload", 'upload')(data-toggle="modal" data-target="#uploadAssignment" onclick="javascript:preUploadAssignment('#{ass._id}', '#{ass.name}')")
                for handin in handins
                    +flipper()(class="group")
                        +front-card() 
                            if !handin.final
                                .assignmentStateBulb.back-final
                            else
                                .assignmentStateBulb.back-done
                            if handin.file.feedback.length == 0
                                .assignmentStateFeedback.back-normal
                            else 
                                .assignmentStateFeedback.back-done
                            .yAlign
                                h3.special= handin.file.name
                                +timeline(group.start, group.end, group.now)(class="hidden")
                        +back-card()
                            +card-icons() 
                                .bottom-icons
                                    +card-icon-a("/file/" + handin.file._id, 'View Hand-in Page', 'list-alt')
                                    if !handin.final
                                        +card-icon("Accept Hand-in", 'ok')(data-toggle="modal" data-target="#acceptAssignment" onclick="javascript:preAccept('#{handin.file._id}', '#{handin.file.name}')")
                                        +card-icon("Decline Hand-in", 'remove')(data-toggle="modal" data-target="#declineAssignment" onclick="javascript:preDecline('#{handin.file._id}', '#{handin.file.name}')")
            hr

        if group.assignments.length > 0 && (user.admin || group.assignments.length > 1 || group.assignments[0].typ != "open")
            h2 Assignments
            .row.groups
                for ass in group.assignments
                    - var file = files.filter(f => f.file.assignment.toString() == ass._id.toString())
                    - var done = file.length > 0
                    - var open = ass.typ == "open"
                    if !open || user.admin
                        +flipper()(class="group")
                            +front-card()
                                if !user.admin
                                    if done
                                        if !file[0].final
                                            .assignmentStateBulb.back-final
                                        else
                                            if ass.due > file[0].file.timestamp
                                                .assignmentStateBulb.back-done
                                            else
                                                .assignmentStateBulb.back-late
                                        if file[0].file.feedback.length == 0
                                            .assignmentStateFeedback.back-normal
                                        else 
                                            .assignmentStateFeedback.back-done
                                    else
                                        if ass.due > new Date()
                                            .assignmentStateBulb.back-normal
                                        else 
                                            .assignmentStateBulb.back-due
                                .yAlign
                                    h3.special= ass.name
                                    if !user.admin && done
                                        h4#subheadersmall= file[0].file.name
                                    .timeline-container
                                        if open
                                            +timeline(group.start, group.end)(class="hidden" id="openExists")
                                        else
                                            +timeline(group.start, group.end, ass.due)(class="hidden")
                            +back-card()
                                +card-icons()
                                    if user.admin
                                        if ass.link.length > 0
                                            .top-icons
                                                +card-icon-a("/file/" + file[0].file._id, 'Results', 'list-alt')
                                                +card-icon('Edit Assignment', 'cog')
                                            .bottom-icons
                                                +card-icon('Remove Assignment', 'trash')(data-toggle="modal" data-target="#removeAssignment" onclick="javascript:preRemoveAssignment('#{ass._id}', '#{ass.name}')")
                                                +card-icon-a("http://" + ass.link, 'Additional Info', 'info-sign')(target='_blank')
                                        else
                                            .bottom-icons
                                                +card-icon-a(group._id + "/assignment/" + ass._id, 'Results', 'list-alt')
                                                +card-icon('Edit Assignment', 'cog')
                                                +card-icon('Remove Assignment', 'trash')(data-toggle="modal" data-target="#removeAssignment" onclick="javascript:preRemoveAssignment('#{ass._id}', '#{ass.name}')")
                                    else
                                        if !done
                                            .bottom-icons
                                                +card-icon("Upload", 'upload')(data-toggle="modal" data-target="#uploadAssignment" onclick="javascript:preUploadAssignment('#{ass._id}', '#{ass.name}')")
                                                if ass.link.length > 0
                                                    +card-icon-a("http://" + ass.link, 'Additional Info', 'info-sign')(target='_blank')
                                        else
                                            .bottom-icons
                                                +card-icon-a("/file/" + file[0].file._id, 'View Hand-in Page', 'list-alt')
                                                if !file[0].final
                                                    +card-icon("Accept Hand-in", 'ok')(data-toggle="modal" data-target="#acceptAssignment" onclick="javascript:preAccept('#{file[0].file._id}', '#{file[0].file.name}')")
                                                    +card-icon("Decline Hand-in", 'remove')(data-toggle="modal" data-target="#declineAssignment" onclick="javascript:preDecline('#{file[0].file._id}', '#{file[0].file.name}')")
                                                if ass.link.length > 0
                                                    +card-icon-a("http://" + ass.link, 'Additional Info', 'info-sign')(target='_blank')
        else
            h2 Assignments
            p No assignments were made yet!
        hr
        .row
            if user.admin
                +cardLink("Create a New Assignment")(data-toggle="modal" data-target="#addAssignment")
                +cardLink("To-Feedback List")
                +cardLink("View all Results")
            else
                +cardLink("Generate Overview")
                +cardLink("Mail Users")
        if user.admin                
            hr
            h2 Users
            .row
                .col-sm-6
                    +cardTable("Students")
                        for usr in group.students
                            -users.push('"' + usr._id + '"')
                            +cardTableFlip(usr.name + " " + usr.surename)
                                if usr._id == user.id
                                    p This is you :)
                                else
                                    .bottom-icons
                                        +flip-table-a("mailto:" + usr._id + "@student.utwente.nl", "envelope")(target="_blank")
                                        +flip-table-a(group._id + "/user/" + usr._id, "list-alt")(target="_blank")
                                        +flip-table-icon("trash")

                .col-sm-6
                    +cardTable("Instructors")
                        for usr in group.admins
                            -users.push('"' + usr._id + '"')
                            +cardTableFlip(usr.name + " " + usr.surename)
                                if usr._id == user.id
                                    p This is you :)
                                else
                                    .bottom-icons
                                        +flip-table-icon("envelope")
                                        +flip-table-icon("trash")
            hr
            .row
                if user.admin
                    +cardLink("Add Users")(data-toggle="modal" data-target="#addUsers" onclick='javascript:getUsers(`[#{users}]`)')
                    +cardLink("Mail Users")

    if user.admin
        .modal.fade#addAssignment(tabindex="-1" role="dialog" aria-labelledby="assignmentLabel")
            .modal-dialog(role="document")
                .modal-content
                    .modal-header
                        button(type="button" class="close" data-dismiss="modal" aria-label="Close")
                            span(aria-hidden="true") &times;
                        h4.modal-title#assignmentLabel Create a New Assignment
                    .modal-body
                        #errorContainer.hidden
                            .alert.alert-danger
                                b Please review the following errors:
                                ul#errors
                            hr
                        .row
                            .col-xs-8
                                .input-group
                                    span.input-group-addon#addonName Name
                                    input.form-control#assignmentName(type="text" aria-describedby="addonName")
                            .col-xs-4
                                .input-group
                                    span.input-group-addon#addonType Type
                                    select.form-control.selectTrigger#assignmentType(name="assignmentType" container="#assignment-data" aria-describedby="addonType")
                                        option(value="defined") Defined
                                        option(value="open") Open
                                        option(value="autograder") Autograder
                        #assignment-data
                            .selectActor(data="defined")
                                .row.mtop10
                                    .col-xs-8
                                        .input-group.date(data-provide="datepicker")
                                            span.input-group-addon#addonDue Due Date
                                            input.form-control#dueDate(type="text" aria-describedby="addonDue")
                                            .input-group-addon
                                                span.glyphicon.glyphicon-calendar
                                hr
                                label(for="infoLink") Additional Information Link (optional)
                                .input-group
                                    span.input-group-addon#addonLink http://
                                    input.form-control#infoLink(type="text" aria-describedby="addonName")
                            .selectActor.hidden(data="autograder")
                                hr
                                .alert.alert-warning
                                    p Sorry, the autograder option is disabled in this version!

                    .modal-footer
                        button(type="button" class="btn btn-default" data-dismiss="modal") Close
                        button(type="button" class="btn btn-primary" onclick="javascript:createAssignment('#{group._id}', '#{group.start}', '#{group.end}')") Create Assignment

        .modal.fade#removeAssignment(tabindex="-1" role="dialog" aria-labelledby="assignmentDeleteLabel")
            .modal-dialog(role="document")
                .modal-content
                    .modal-header
                        button(type="button" class="close" data-dismiss="modal" aria-label="Close")
                            span(aria-hidden="true") &times;
                        h4.modal-title#assignmentDeleteLabel Are you sure?
                    .modal-body
                        #assignmentRemoveContainer.hidden
                            .alert.alert-danger
                                b Please review the following errors:
                                ul#assignmentRemove
                            hr
                        .alert.alert-warning
                            p
                                b Warning! 
                                | Your are about to delete the assignment: '
                                span#removeAssignmentName
                                |'!
                            p This assignment will dissappear for all users. This is 
                                b unrecoverable
                                |!
                        .alert.alert-info 
                            p 
                                b Note 
                                | Hand-in data (files, feedback and reflections) will be kept but can only be accessed through direct links.
                    .modal-footer
                        button(type="button" class="btn btn-default" data-dismiss="modal") Close
                        button#removeAssignment(type="button" class="btn btn-danger" onclick="javascript:removeAssignment()" assignment="") Delete Assignment

        .modal.fade#addUsers(tabindex="-1" role="dialog" aria-labelledby="usersLabel")
            .modal-dialog(role="document")
                .modal-content
                    .modal-header
                        button(type="button" class="close" data-dismiss="modal" aria-label="Close")
                            span(aria-hidden="true") &times;
                        h4.modal-title#usersLabel Add Users
                    .modal-body
                        #errorContainerUser.hidden
                            .alert.alert-danger
                                b Please review the following errors:
                                ul#errorsUser
                            hr
                        .row
                            .col-xs-8
                                .well.multiSelect#userSelect
                                    ul.list-group.checked-list-box#allUserList
                            .col-xs-4
                                .input-group
                                    span.input-group-addon#addonRole Role
                                    select.form-control#userRole(name="userRole" aria-describedby="addonRole")
                                        option(value="student") Student
                                        option(value="admin") Instructor

                    .modal-footer
                        button(type="button" class="btn btn-default" data-dismiss="modal") Close
                        button(type="button" class="btn btn-primary" onclick="javascript:addUsers('#{group._id}')") Add Users

    .modal.fade#uploadAssignment(tabindex="-1" role="dialog" aria-labelledby="uploadLabel")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    button(type="button" class="close" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") &times;
                    h4.modal-title#uploadLabel 
                        |Upload Assignment: 
                        span#assignmentUploadId
                .modal-body
                    #errorContainerUpload.hidden
                        .alert.alert-danger
                            b Please review the following errors:
                            ul#errorsUpload
                        hr
                    .input-group
                        span.input-group-addon#addonHName Hand-in Name
                        input.form-control#handInName(type="text" aria-describedby="addonHName")
                    hr
                    .form-group
                        form.dropzone.form-control#uploadedFiles(action="file-upload" method="post" enctype="multipart/form-data")
                            input.hide(type="file" name="files")
                            .dz-message.yAlign
                                p Click or drag files to upload.
                    label(for="uploadedFilesSelect") Uploaded Files
                    .well#uploadedFilesSelect
                        ul.list-group.checked-list-box#uploadedFilesList
                    hr
                    label(for="userSelect") Partners
                    .well#studentSelect
                        ul.list-group.checked-list-box#studentUserList
                            for student in group.students
                                if student._id != user.id
                                    li.list-group-item(value=student._id) #{student.name} #{student.surename} (#{student._id})
                    .alert.alert-info
                        span
                            b Note
                            |! Your partners to not need to hand in this assignment anymore, they do need to accept this hand-in however (from the dashboard).
                    hr
                    .form-group
                        label.control-label(for="comments") Additional Comments (optional)
                        textarea.form-control#comments(rows="5")

                .modal-footer
                    button(type="button" class="btn btn-default" data-dismiss="modal") Close
                    button(type="button" class="btn btn-primary" onclick="javascript:upload()") Upload Assignment

    .modal.fade#acceptAssignment(tabindex="-1" role="dialog" aria-labelledby="acceptLabel")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    button(type="button" class="close" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") &times;
                    h4.modal-title#acceptLabel 
                        |Accept Assignment:  
                        span#assignmentAccept
                .modal-body
                    .alert.alert-info
                        span Are you sure you want to accept this assignment?
                .modal-footer
                    button(type="button" class="btn btn-default" data-dismiss="modal") Close
                    button(type="button" class="btn btn-primary" onclick="javascript:acceptAssignment('#{group._id}')") I'm Completely Sure

    .modal.fade#declineAssignment(tabindex="-1" role="dialog" aria-labelledby="declineLabel")
        .modal-dialog(role="document")
            .modal-content
                .modal-header
                    button(type="button" class="close" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") &times;
                    h4.modal-title#declineLabel 
                        |Decline Assignment:  
                        span#assignmentDecline
                .modal-body
                    .alert.alert-warning
                        span Are you sure you want to decline this assignment?
                .modal-footer
                    button(type="button" class="btn btn-default" data-dismiss="modal") Close
                    button(type="button" class="btn btn-primary" onclick="javascript:declineAssignment('#{group._id}')") I'm Completely Sure
